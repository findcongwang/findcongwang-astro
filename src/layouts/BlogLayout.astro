---
import { Image } from "astro:assets";
// Fundations
import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Icons
import ChevronLeft from "@/components/fundations/icons/ChevronLeft.astro";
// Components
import ShareButtons from "@/components/fundations/elements/ShareButtons.astro";
import BlogEntry from "@/components/blog/BlogEntry.astro";
// Content
const { frontmatter } = Astro.props;
import { getCollection } from "astro:content";
import { getDomainLineages } from "@/utils/domains";

const allPosts = await getCollection("posts");
const allDomains = await getCollection("domains");

// Get related posts by tags
const relatedPosts = allPosts.filter(
  (post) =>
    post.slug !== Astro.url.pathname.split("/").filter(Boolean).pop() &&
    post.data.tags?.some((tag) => frontmatter.tags?.includes(tag))
);

// Get domain lineages
const domainLineages = frontmatter.domains
  ? await getDomainLineages(frontmatter.domains, allDomains)
  : [];
---

<BaseLayout>
  <section>
    <Wrapper variant="standard" class="pt-24 pb-12 lg:pt-48">
      <a
        href="/blog"
        class="flex items-center text-xs text-primary hover:text-primary/60 gap-2"
      >
        <ChevronLeft slot="icon" size="sm" />
        Go back</a
      >
      <div
        class="mt-12 grid gap-4 lg:gap-8 grid-cols-1 lg:grid-cols-3 lg:items-start"
      >
        <div class="text-balance lg:col-span-2">
          <Text tag="h1" variant="textBase" class="text-primary">
            {frontmatter.title}
          </Text>
          <Text
            tag="p"
            variant="textSM"
            class="font-serif text-primary/60 text-balance"
          >
            {frontmatter.description}
          </Text>
          <Image
            width={1000}
            height={800}
            alt={frontmatter.image.alt}
            src={frontmatter.image.url}
            class="object-cover object-center w-full mt-4 aspect-12/6 lg:col-span-2 rounded-xl"
          />
          <Wrapper variant="prose" class="mt-4">
            <slot />
          </Wrapper>
        </div>

        <div class="lg:sticky lg:top-24">
          <div class="space-y-4">
            <div>
              <Text tag="p" variant="textXS" class="text-primary/60">
                <time
                  datetime={new Date(frontmatter.pubDate).toISOString()}
                >
                  {new Date(frontmatter.pubDate).toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "long",
                    day: "2-digit",
                  })}
                </time>
              </Text>
            </div>

            {frontmatter.tags && frontmatter.tags.length > 0 && (
              <div>
                <Text tag="p" variant="textXS" class="text-primary/60">
                  Tags: {frontmatter.tags.join(", ")}
                </Text>
              </div>
            )}

            {domainLineages.length > 0 && (
              <div>
                <Text tag="p" variant="textXS" class="text-primary/60">
                  Domains: {domainLineages.join(", ")}
                </Text>
              </div>
            )}

            <div
              class="relative flex flex-wrap pt-2 mt-2 border-t border-dotted border-primary/10 gap-2"
            >
              <ShareButtons description={frontmatter.description} />
            </div>
          </div>
        </div>
      </div>
    </Wrapper>
  </section>
  {
    relatedPosts.length > 0 && (
      <section class="">
        <Wrapper variant="standard" class="py-12">
          <Text tag="h2" variant="textBase" class="text-primary ">
            Related posts
          </Text>
          <div class="flex flex-col pt-2 mt-2 border-t border-dotted gap-2 border-primary/10">
            {relatedPosts.slice(0, 3).map((post) => (
              <BlogEntry post={post} />
            ))}
          </div>
        </Wrapper>
      </section>
    )
  }
</BaseLayout>
