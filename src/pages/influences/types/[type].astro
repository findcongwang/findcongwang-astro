---
// Fundations
import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Components
import InfluencesEntry from "@/components/influences/InfluencesEntry.astro";
// Content
import { getCollection } from "astro:content";
// Utils
import { INFLUENCE_TYPES } from "@/utils/influences";

export async function getStaticPaths() {
  const allInfluences = await getCollection("influences");
  
  return INFLUENCE_TYPES.map((type) => {
    const filteredInfluences = allInfluences.filter((influence) =>
      influence.data.type === type
    );
    return {
      params: { type },
      props: { influences: filteredInfluences },
    };
  });
}

const { type } = Astro.params;
const { influences } = Astro.props;

// Get all influences for type filter display
const allInfluences = await getCollection("influences");
const types = ["all", ...INFLUENCE_TYPES];

// Sort filtered influences alphabetically
const sortedInfluences = influences.sort((a, b) => 
  a.data.name.localeCompare(b.data.name)
);

const completedInfluences = sortedInfluences.filter(
  (item) => !item.data.description?.toLowerCase().includes("page under construction")
);
const underConstructionInfluences = sortedInfluences.filter(
  (item) => item.data.description?.toLowerCase().includes("page under construction")
);
---

<BaseLayout pageTitle={type}>
  <section>
    <Wrapper variant="standard" class="pt-24 pb-12 lg:pt-48">
      <Text
        tag="h1"
        variant="textBase"
        class="font-medium capitalize text-primary"
      >
        {type}
      </Text>

      <div
        class="relative flex h-full mt-1 overflow-x-scroll gap-2 lg:gap-4 scrollable-content snap-x snap-proximity scrollbar-hide"
      >
        {
          types.map((t) => (
            <a
              title={t}
              aria-label={t}
              href={t === "all" ? "/influences" : `/influences/types/${t}`}
              class={`text-xs capitalize ${
                t === type ? "text-accent" : "text-primary/60 hover:text-accent"
              }`}
            >
              {t}
            </a>
          ))
        }
      </div>
      
      {completedInfluences.length > 0 && (
        <div
          class="border-t border-dotted border-primary/10 pt-2 mt-2 flex flex-col gap-4"
        >
          {completedInfluences.map((post) => <InfluencesEntry post={post} />)}
        </div>
      )}

      {underConstructionInfluences.length > 0 && (
        <div class="mt-12">
          <Text tag="h2" variant="textBase" class="text-primary mb-4">
            Pages Under Construction
          </Text>
          <div
            class="border-t border-dotted border-primary/10 pt-2 flex flex-col gap-2"
          >
            {underConstructionInfluences.map((post) => <InfluencesEntry post={post} />)}
          </div>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>

