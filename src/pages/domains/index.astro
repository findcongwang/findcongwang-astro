---
import BaseLayout from "@/layouts/BaseLayout.astro";

import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import WorksEntries from "@/components/works/WorksEntries.astro";
import { getCollection } from "astro:content";
import { getDomainDepth } from "@/utils/domains";

const allDomains = await getCollection("domains");

// Calculate depth for each domain and group by depth
const domainsWithDepth = allDomains.map(domain => ({
  domain,
  depth: getDomainDepth(domain.slug, allDomains)
}));

// Group by depth
const domainsByDepth: Record<number, typeof allDomains> = {};
domainsWithDepth.forEach(({ domain, depth }) => {
  if (!domainsByDepth[depth]) {
    domainsByDepth[depth] = [];
  }
  domainsByDepth[depth].push(domain);
});

// Sort domains within each depth group alphabetically
Object.keys(domainsByDepth).forEach(depth => {
  domainsByDepth[Number(depth)].sort((a, b) => 
    a.data.title.localeCompare(b.data.title)
  );
});

// Get sorted depth levels
const depthLevels = Object.keys(domainsByDepth)
  .map(Number)
  .sort((a, b) => a - b);
---

<BaseLayout>
  <section>
    <Wrapper variant="standard" class="pt-24 pb-12 lg:pt-48">
      <Text tag="h1" variant="textBase" class="text-primary"> Domains </Text>

      <Text
        tag="p"
        variant="textBase"
        class="font-serif text-primary/60 text-balance"
      >
        Domains are how I organize my thinking, these notes are atlas-level overviews. Sometimes, a topic crosses multiple domains at different levels of abstraction. I do my best to avoid cyclic dependencies.
      </Text>

      {depthLevels.map((depth) => {
        const domainsAtDepth = domainsByDepth[depth];
        if (!domainsAtDepth || domainsAtDepth.length === 0) return null;
        
        return (
          <div class={depth === 0 ? "mt-8" : "mt-12"}>
            {depth > 0 && (
              <Text tag="h2" variant="textBase" class="text-primary mb-4">
                Level {depth}
              </Text>
            )}
            <div
              class={depth === 0 
                ? "pt-2 flex flex-col gap-4"
                : "border-t border-dotted border-primary/10 pt-2 flex flex-col gap-4"
              }
            >
              {domainsAtDepth.map((post) => <WorksEntries post={post} basePath="/domains/" />)}
            </div>
          </div>
        );
      })}
    </Wrapper>
  </section>
</BaseLayout>

